# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/reference/configuration-reference
version: 2.1

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#jobs-overview & https://circleci.com/docs/reference/configuration-reference/#jobs
jobs:
  build-and-test:
    # Use machine executor to avoid Docker Hub rate limiting
    # Machine executor comes with Java and Maven pre-installed
    machine:
      image: ubuntu-2204:2023.10.1

    # Add steps to the job
    # See: https://circleci.com/docs/guides/orchestrate/jobs-steps/#steps-overview & https://circleci.com/docs/reference/configuration-reference/#steps
    steps:
      # Checkout the code as the first step.
      - checkout

      # Install Java 21 and Maven 3.9.6
      - run:
          name: "Install Java 21 and Maven"
          command: |
            sudo apt-get update
            sudo apt-get install -y openjdk-21-jdk wget

            # Set Java 21 as default
            sudo update-alternatives --set java /usr/lib/jvm/java-21-openjdk-amd64/bin/java
            sudo update-alternatives --set javac /usr/lib/jvm/java-21-openjdk-amd64/bin/javac
            export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
            echo 'export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64' >> $BASH_ENV

            # Download and install Maven 3.9.6
            wget https://archive.apache.org/dist/maven/maven-3/3.9.6/binaries/apache-maven-3.9.6-bin.tar.gz
            sudo tar xzf apache-maven-3.9.6-bin.tar.gz -C /opt
            sudo ln -s /opt/apache-maven-3.9.6 /opt/maven

            # Set Maven environment variables
            echo 'export M2_HOME=/opt/maven' >> $BASH_ENV
            echo 'export PATH=$M2_HOME/bin:$PATH' >> $BASH_ENV
            source $BASH_ENV

            java -version
            mvn -version

      - run:
          name: "Build and run tests"
          command: "mvn install"

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/guides/orchestrate/workflows/ & https://circleci.com/docs/reference/configuration-reference/#workflows
workflows:
  build-test:
    jobs:
      - build-and-test:
          filters:
            branches:
              only:
                - master
